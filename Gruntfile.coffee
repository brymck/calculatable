'use strict'

module.exports = (grunt) ->

  require('load-grunt-tasks')(grunt)

  version = ->
    grunt.file.readJSON('package.json').version
  version_tag = ->
    "v#{version()}"

  grunt.initConfig
    pkg: grunt.file.readJSON('package.json')
    comments: """
/*!
Calculatable is best
by Bryan McKelvey

Version <%= pkg.version %>
Full source at https://github.com/brymck/calculatable
Copyright (c) 2014-<%= grunt.template.today('yyyy') %> Bryan McKelvey

MIT License, https://github.com/brymck/calculatable/blob/master/LICENSE
This file is generated by 'grunt build'. Do not edit it by hand.
*/
\n
"""

    minified_comments: "/* Calculatable #{version_tag()} | (c) 2014-<%= grunt.template.today('yyyy') %> by Bryan McKelvey | MIT License, https://github.com/brymck/calculatable/blob/master/LICENSE */\n"

    concat:
      options:
        banner: '<%= comments %>'
      jquery:
        src: ['build/calculatable.jquery.js']
        dest: 'build/calculatable.jquery.js'
      css:
        src: ['build/calculatable.css']
        dest: 'build/calculatable.css'

    coffee:
      dist:
        options:
          bare: yes
          sourceMap: yes
        expand: yes
        cwd: 'build'
        src: ['**/*.coffee']
        dest: 'build'
        ext: '.js'
      test:
        options:
          bare: yes
        expand: yes
        cwd: 'spec'
        src: ['coffee/**/*.coffee']
        dest: 'spec/js'
        ext: '.js'

    mapcat:
      dist:
        src: ['build/coffee/lib/**/*.js.map', 'build/coffee/calculatable.js.map']
        dest: 'build/calculatable.jquery.js'

    uglify:
      dist:
        options:
          banner: '<%= minified_comments %>'
          mangle:
            except: ['jQuery', 'Calculatable']
          sourceMap: yes
          sourceMapIn: 'build/calculatable.jquery.js.map'
        files:
          'build/calculatable.jquery.min.js': 'build/calculatable.jquery.js'

    compass:
      dist:
        options:
          bundleExec: yes
          cssDir: 'build/'
          sassDir: 'sass/'
          specify: ['sass/calculatable.scss']

    cssmin:
      dist:
        options:
          banner: '<%= minified_comments %>'
          keepSpecialComments: 0
        src: 'build/calculatable.css'
        dest: 'build/calculatable.min.css'

    copy:
      coffee:
        files: [
          expand: yes
          cwd: 'coffee'
          src: ['**/*.coffee']
          dest: 'build/coffee'
        ]
      dist:
        files: [
          expand: yes
          cwd: 'build'
          src: ['calculatable*.{js,css}']
          dest: 'dist/'
        ]

    connect:
      server:
        options:
          port: 8000
          base: '.'

    qunit:
      all:
        options:
          urls:
            ['http://localhost:8000/test/index.html']

    jasmine:
      dist:
        src: 'build/calculatable.jquery.js'
        options:
          specs: 'spec/js/**/*_spec.js'
          helpers: 'spec/js/**/*_helper.coffee'
          vendor:
            ['node_modules/jquery/dist/jquery.min.js']

    watch:
      coffee:
        files: 'coffee/**/*.coffee'
        tasks: 'build:coffee'
      sass:
        files: 'sass/**/*.scss'
        tasks: 'build:sass'
      test:
        files: 'spec/coffee/**/*.coffee'
        tasks: 'test'

    clean:
      coffee: ['build/coffee/**/*.js', 'build/coffee/**/*.map']
      dist: ['dist/']
      test: ['spec/js/']
      zip: ['*.zip']

    build_gh_pages:
      gh_pages: {}

    dom_munger:
      latest_version:
        src: ['dist/index.html', 'dist/options.html']
        options:
          callback: ($) ->
            $('#latest-version').text(version_tag())

    zip:
      dist:
        cwd: 'dist/'
        src: ['dist/**/*']
        dest: "calculatable_#{version_tag()}.zip"

  grunt.registerTask 'default', 'build'
  grunt.registerTask 'build:sass', [
    'compass'
    'cssmin'
  ]
  grunt.registerTask 'build:coffee', [
    'copy:coffee'
    'coffee:dist'
    'mapcat'
    'test'
    'uglify'
    'clean:coffee'
  ]
  grunt.registerTask 'build', [
    'clean'
    'build:coffee'
    'build:sass'
    'concat'
    'copy:dist'
  ]
  grunt.registerTask 'test', [
    'clean:test'
    'coffee:test'
    'jasmine'
  ]
  grunt.registerTask 'gh_pages', ['copy:dist', 'build_gh_pages:gh_pages']
  grunt.registerTask 'prep_release', ['build', 'dom_munger:latest_version', 'zip', 'package_jquery']

  grunt.registerTask 'package_jquery', 'Generate a jquery.json manifest file from package.json', () ->
    src = 'package.json'
    dest = 'calculatable.jquery.json'
    pkg = grunt.readJSON(src)
    json1 =
      name: pkg.name
      description: pkg.description
      version: version()
      licenses: pkg.licenses
    json2 = pkg.jqueryJSON
    json1[key] = json2[key] for key of json2
    json1.author.name = pkg.author
    grunt.file.write('calculatable.jquery.json', JSON.stringify(json1, null, 2))
